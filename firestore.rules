rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user's team member data
    function getTeamMember() {
      return get(/databases/$(database)/documents/teamMembers/$(request.auth.uid)).data;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getTeamMember().role == 'admin';
    }
    
    // Helper function to check if user belongs to a company
    function belongsToCompany(companyId) {
      return isAuthenticated() && getTeamMember().companyId == companyId;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper: Validate string field with max length
    function isValidString(value, maxLen) {
      return value is string && value.size() >= 1 && value.size() <= maxLen;
    }
    
    // Helper: Validate email format
    function isValidEmail(email) {
      return email is string && email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    // Helper: Validate phone (only digits, 10-15 chars)
    function isValidPhone(phone) {
      return phone is string && phone.matches('^[0-9]{10,15}$');
    }

    // Team Members Collection
    match /teamMembers/{memberId} {
      // Allow read for authenticated users of the same company OR reading own document
      allow read: if isAuthenticated() && (
        request.auth.uid == memberId || 
        (exists(/databases/$(database)/documents/teamMembers/$(request.auth.uid)) &&
         belongsToCompany(resource.data.companyId))
      );
      
      // Allow create: user can create their own profile, or admin can create for their company
      allow create: if isAuthenticated() && (
        // New user creating their own profile during registration
        request.auth.uid == memberId ||
        // Admin creating team member for their company
        (exists(/databases/$(database)/documents/teamMembers/$(request.auth.uid)) && isAdmin())
      ) && 
        isValidString(request.resource.data.nome, 100) &&
        isValidEmail(request.resource.data.email) &&
        request.resource.data.role in ['admin', 'corretor', 'gestor'];
      
      // Allow update: users cannot modify their own role or companyId
      allow update: if isAuthenticated() && (
        // Admins can update other members in their company
        (isAdmin() && belongsToCompany(resource.data.companyId)) ||
        // Users can update their own profile but NOT role or companyId
        (request.auth.uid == memberId && 
          // role nunca pode mudar pelo próprio usuário
          request.resource.data.role == resource.data.role &&
          (
            // caminho padrão: companyId não muda
            request.resource.data.companyId == resource.data.companyId ||
            // migração segura: se companyId estava vazio, permitir setar para o próprio uid (uma única vez)
            (resource.data.companyId == null && request.resource.data.companyId == request.auth.uid)
          )
        )
      );
      
      // Only admins can delete members in their company
      allow delete: if isAdmin() && belongsToCompany(resource.data.companyId);
    }

    // Companies Collection
    match /companies/{companyId} {
      allow read: if belongsToCompany(companyId);
      allow create: if isAuthenticated() &&
        isValidString(request.resource.data.nome, 100);
      allow update, delete: if isAdmin() && belongsToCompany(companyId);
    }

    // Clients Collection
    match /clients/{clientId} {
      // Read: authenticated users can only see clients from their company
      allow read: if isAuthenticated() && belongsToCompany(resource.data.companyId);
      
      // Create: with validation
      allow create: if isAuthenticated() && 
        request.resource.data.companyId == getTeamMember().companyId &&
        isValidString(request.resource.data.nome, 100);
      
      // Update: users can update clients in their company
      allow update: if isAuthenticated() && 
        belongsToCompany(resource.data.companyId) &&
        request.resource.data.companyId == resource.data.companyId;
      
      // Delete: only admins can delete clients
      allow delete: if isAdmin() && belongsToCompany(resource.data.companyId);
    }

    // Visits Collection
    match /visits/{visitId} {
      allow read: if isAuthenticated() && belongsToCompany(resource.data.companyId);
      allow create: if isAuthenticated() && 
        request.resource.data.companyId == getTeamMember().companyId;
      allow update: if isAuthenticated() && belongsToCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.corretorId) || isAdmin()
      ) && belongsToCompany(resource.data.companyId);
    }

    // Interactions Collection
    match /interactions/{interactionId} {
      allow read: if isAuthenticated() && belongsToCompany(resource.data.companyId);
      allow create: if isAuthenticated() && 
        request.resource.data.companyId == getTeamMember().companyId;
      allow update: if isAuthenticated() && belongsToCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.corretorId) || isAdmin()
      ) && belongsToCompany(resource.data.companyId);
    }

    // Notifications Collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
        belongsToCompany(resource.data.companyId) &&
        (resource.data.destinatarioId == 'all' || resource.data.destinatarioId == request.auth.uid);
      
      allow create: if isAdmin() && 
        request.resource.data.companyId == getTeamMember().companyId;
      
      allow update: if isAuthenticated() && 
        belongsToCompany(resource.data.companyId) &&
        (resource.data.destinatarioId == 'all' || resource.data.destinatarioId == request.auth.uid);
      
      allow delete: if isAdmin() && belongsToCompany(resource.data.companyId);
    }

    // Payment Receipts Collection
    match /paymentReceipts/{receiptId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Only super admin can approve/reject
      allow update: if isAuthenticated() && 
        request.auth.token.email == 'davimendesfinatte@gmail.com';
      
      allow delete: if false;
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
