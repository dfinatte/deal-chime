rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user's team member data
    function getTeamMember() {
      return get(/databases/$(database)/documents/teamMembers/$(request.auth.uid)).data;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getTeamMember().role == 'admin';
    }
    
    // Helper function to check if user belongs to a company
    function belongsToCompany(companyId) {
      return isAuthenticated() && getTeamMember().companyId == companyId;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Team Members Collection
    match /teamMembers/{memberId} {
      // Allow read for authenticated users of the same company
      allow read: if isAuthenticated() && (
        request.auth.uid == memberId || 
        belongsToCompany(resource.data.companyId)
      );
      
      // Allow create only for admins or self-registration (new companies)
      allow create: if isAuthenticated() && (
        isAdmin() || 
        request.auth.uid == memberId
      );
      
      // Allow update: users cannot modify their own role or companyId
      allow update: if isAuthenticated() && (
        // Admins can update other members in their company
        (isAdmin() && belongsToCompany(resource.data.companyId)) ||
        // Users can update their own profile but NOT role or companyId
        (request.auth.uid == memberId && 
         request.resource.data.role == resource.data.role &&
         request.resource.data.companyId == resource.data.companyId)
      );
      
      // Only admins can delete members in their company
      allow delete: if isAdmin() && belongsToCompany(resource.data.companyId);
    }

    // Companies Collection
    match /companies/{companyId} {
      allow read: if belongsToCompany(companyId);
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin() && belongsToCompany(companyId);
    }

    // Clients Collection
    match /clients/{clientId} {
      // Read: authenticated users can only see clients from their company
      allow read: if isAuthenticated() && belongsToCompany(resource.data.companyId);
      
      // Create: authenticated users can create clients for their company
      allow create: if isAuthenticated() && 
        request.resource.data.companyId == getTeamMember().companyId;
      
      // Update: users can update clients in their company
      allow update: if isAuthenticated() && 
        belongsToCompany(resource.data.companyId) &&
        request.resource.data.companyId == resource.data.companyId; // Prevent changing companyId
      
      // Delete: only admins can delete clients
      allow delete: if isAdmin() && belongsToCompany(resource.data.companyId);
    }

    // Visits Collection
    match /visits/{visitId} {
      allow read: if isAuthenticated() && belongsToCompany(resource.data.companyId);
      allow create: if isAuthenticated() && 
        request.resource.data.companyId == getTeamMember().companyId;
      allow update: if isAuthenticated() && belongsToCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.corretorId) || isAdmin()
      ) && belongsToCompany(resource.data.companyId);
    }

    // Interactions Collection
    match /interactions/{interactionId} {
      allow read: if isAuthenticated() && belongsToCompany(resource.data.companyId);
      allow create: if isAuthenticated() && 
        request.resource.data.companyId == getTeamMember().companyId;
      allow update: if isAuthenticated() && belongsToCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.corretorId) || isAdmin()
      ) && belongsToCompany(resource.data.companyId);
    }

    // Notifications Collection
    match /notifications/{notificationId} {
      // Read: users can see notifications for their company that are addressed to them or all
      allow read: if isAuthenticated() && 
        belongsToCompany(resource.data.companyId) &&
        (resource.data.destinatarioId == 'all' || resource.data.destinatarioId == request.auth.uid);
      
      // Create: only admins can send notifications
      allow create: if isAdmin() && 
        request.resource.data.companyId == getTeamMember().companyId;
      
      // Update: users can mark their own notifications as read
      allow update: if isAuthenticated() && 
        belongsToCompany(resource.data.companyId) &&
        (resource.data.destinatarioId == 'all' || resource.data.destinatarioId == request.auth.uid);
      
      // Delete: only admins can delete notifications
      allow delete: if isAdmin() && belongsToCompany(resource.data.companyId);
    }

    // Payment Receipts Collection
    match /paymentReceipts/{receiptId} {
      // Users can read their own receipts
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Users can create receipts for themselves
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Only super admin (davimendesfinatte@gmail.com) can approve/reject
      // Regular users cannot update receipts
      allow update: if isAuthenticated() && 
        request.auth.token.email == 'davimendesfinatte@gmail.com';
      
      // No delete allowed
      allow delete: if false;
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
